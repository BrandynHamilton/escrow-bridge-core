<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ðŸ“» Escrow Bridge Listener Dashboard</title>
<script src="https://cdn.plot.ly/plotly-3.0.1.min.js"></script>
<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 1.5rem;
    text-align: center;
  }

  h1 {
    margin-bottom: 1rem;
  }

  .chart-container {
    display: inline-block;
    width: 100%;
    max-width: 600px;
    height: 400px;
    margin: 50px; /* buffer between charts */
    vertical-align: top;
  }

  .chart-inner {
    width: 100%;
    height: 100%;
  }

  .chart-label {
    margin-top: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    color: #333;
  }
  #rates-display {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .rate-card {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 1rem;
    background: #f9f9f9;
    width: 250px;
    text-align: left;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    overflow-wrap: break-word;   /* allow long words to wrap */
    word-break: break-word;      /* ensure addresses wrap */
  }
  .rate-card h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    color: #333;
  }
  .rate-card p {
    margin: 0.25rem 0;
    font-size: 0.9rem;
  }
  .rate-card small {
    color: #666;
    font-size: 0.75rem;
    display: block;              /* force it onto its own line */
    overflow-wrap: break-word;
  }
  .charts-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 2rem;
  }

  footer {
    text-align: center;
    margin-top: 20px;
    padding: 10px;
    background-color: #333;
    color: #fff;
  }
  #escrow-time-container {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
  }
  .email-link {
    color: #ff6600;   /* pick any color (here orange) */
    text-decoration: none;  /* remove underline */
  }
  .email-link:hover {
    color: #cc5200;   /* darker on hover */
    text-decoration: underline;
  }
  #pending-ids-display {
    display: flex;
    flex-wrap: wrap;
    justify-content: center; /* center horizontally */
    gap: 1rem;               /* spacing between cards */
    margin-bottom: 2rem;
  }
  @media (max-width: 768px) {
    .charts-grid {
      flex-direction: column;
      align-items: center;
    }
  }

</style>

<script>
function plotCharts() {
  fetch("/charts")
    .then(r => r.json())
    .then(payload => {
      const fig1 = JSON.parse(payload.graph_1);
      const fig2 = JSON.parse(payload.graph_2);

      document.getElementById("chart1-label").textContent =
        `BlockDAG Testnet Available Balance: ${payload.bdag_balance} BDAG`;
      document.getElementById("chart2-label").textContent =
        `Base Sepolia Available Balance: ${payload.base_usdc_balance} USDC`;

      Plotly.newPlot("chart1-inner", fig1.data, {...fig1.layout, autosize:true}, {responsive:true});
      Plotly.newPlot("chart2-inner", fig2.data, {...fig2.layout, autosize:true}, {responsive:true});
    })
    .catch(err => {
      console.error("Error loading charts:", err);
      document.getElementById("chart1-inner").textContent = "Error loading chart 1";
      document.getElementById("chart2-inner").textContent = "Error loading chart 2";
    });
}

function fetchRates() {
  fetch("/exchange_rates")
    .then(r => r.json())
    .then(data => {
      console.log("Exchange rates:", data);

      const container = document.getElementById("rates-display");
      container.innerHTML = ""; // clear previous

      const rates = data.exchange_rate;
      for (const [network, info] of Object.entries(rates)) {
        const div = document.createElement("div");
        div.className = "rate-card";
        div.innerHTML = `
          <h3>${network} (chainId: ${info.chain_id})</h3>
          <p><strong>Rate:</strong> $${info.rate}</p>
          <p><strong>Token:</strong> ${info.token.symbol} (${info.token.decimals} decimals)</p>
          <p><small>${info.token.address}</small></p>
        `;
        container.appendChild(div);
      }
    })
    .catch(err => console.error("Error fetching rates:", err));
}

function fetchEscrowTime() {
  fetch("/max_escrow_time")
    .then(r => r.json())
    .then(data => {
      const div = document.getElementById("escrow-time-display");
      div.innerHTML = `
        <p><strong>Seconds:</strong> ${data.seconds}</p>
        <p><strong>Minutes:</strong> ${data.minutes}</p>
        <p><strong>Hours:</strong> ${data.hours}</p>
      `;
    })
    .catch(err => console.error("Error fetching escrow time:", err));
}

function fetchNetworkAddresses() {
  fetch("/config")
    .then(r => r.json())
    .then(config => {
      console.log("Escrow bridge config:", config);

      const container = document.getElementById("network-addresses");
      if (!container) return; // skip if container not in HTML

      container.innerHTML = ""; // clear previous content

      for (const [network, info] of Object.entries(config)) {
        const div = document.createElement("div");
        div.className = "rate-card";
        div.innerHTML = `
          <h3>${network}</h3>
          <p><strong>Bridge Address:</strong></p>
          <small>${info.address}</small>
        `;
        container.appendChild(div);
      }
    })
    .catch(err => console.error("Error fetching network addresses:", err));
}

function fetchPendingIds() {
  fetch("/pending_ids")
    .then(r => r.json())
    .then(data => {
      console.log("Pending IDs:", data);
      const container = document.getElementById("pending-ids-display");
      container.innerHTML = ""; // clear old content

      const pending = data.pending_ids || {};

      if (Object.keys(pending).length === 0) {
        container.innerHTML = "<p>No pending escrows ðŸŽ‰</p>";
        return;
      }

      for (const [idHash, network] of Object.entries(pending)) {
        const div = document.createElement("div");
        div.className = "rate-card";
        div.innerHTML = `
          <h3>${network}</h3>
          <p><strong>Escrow ID:</strong></p>
          <small>${idHash}</small>
        `;
        container.appendChild(div);
      }
    })
    .catch(err => {
      console.error("Error fetching pending IDs:", err);
      document.getElementById("pending-ids-display").innerHTML =
        "<p style='color:red;'>Error loading pending escrows</p>";
    });
}

setInterval(fetchRates, 60000 * 30); // poll every 30 minutes
setInterval(fetchPendingIds, 30000);
window.addEventListener("load", () => {
  fetchRates();
  plotCharts();
  fetchPendingIds();
  fetchEscrowTime();
  fetchNetworkAddresses();
});
</script>
</head>

<body>
  <header>
    <h1>ðŸ“» Escrow Bridge Listener Dashboard</h1>
  </header>

  <section id="network-section">
    <h2 style="text-align:center;">Escrow Bridge Addresses</h2>
    <div id="network-addresses" style="display:flex; justify-content:center; flex-wrap:wrap; gap:1rem;"></div>
  </section>

  <!-- Exchange Rates -->
  <section id="rates-section">
    <h2>Exchange Rates</h2>
    <div id="rates-display"></div>
  </section>

  <!-- Escrow Time -->
<section id="escrow-time-section">
  <h2>Max Escrow Duration</h2>
  <div id="escrow-time-container">
    <div id="escrow-time-display" class="rate-card"></div>
  </div>
</section>

  <!-- Pending IDs -->
  <section id="pending-ids-section">
    <h2>Pending Escrow IDs</h2>
    <div id="pending-ids-display"></div>
  </section>

  <!-- Charts -->
  <section id="charts-section">
    <div class="charts-grid">
      <div class="chart-container">
        <div id="chart1-inner" class="chart-inner"></div>
        <div id="chart1-label" class="chart-label"></div>
      </div>
      <div class="chart-container">
        <div id="chart2-inner" class="chart-inner"></div>
        <div id="chart2-label" class="chart-label"></div>
      </div>
    </div>
  </section>

  <footer>
    <p>
      Contact: 
      <a href="mailto:info@escrowbridge.xyz" class="email-link">
        info@escrowbridge.xyz
      </a>
    </p>
  </footer>

</body>

</html>
